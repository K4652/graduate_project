{% extends "layout.html" %}
{% block title %}Analytics{% endblock %}

{% block head %}
  {{ super() }}
  {# List 페이지 CSS 불러오기 #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
{% endblock %}

{% block content %}
  <h2>Analytics</h2>
  <div class="selector-row">
    <table>
      <thead>
        <tr data-report-id="{{ report.report_id }}">
          <th class="sortable">신고 번호</th>
          <th class="sortable">교통법규 위반 사항</th>
          <th class="sortable">영상 날짜</th>
          <th>번호판</th>
          <th>신고 장소</th>
          <th>동영상 다운로드</th>
          <th>즐겨찾기</th>
          <th>추가메뉴</th>
        </tr>
      </thead>
      <tbody>
        <tr data-report-id="{{ report.report_id }}">
          <td>{{ report.report_id }}</td>
          <td class="col-violation">
            <img src="{{ url_for('static', filename='img/Alert.png') }}"
          class="icon-sm" alt="">
            {{ report.violation_type or '–' }}
          </td>
          <td class="col-date">
            <img src="{{ url_for('static', filename='img/Calendar.png') }}"
                 class="icon-sm" alt="캘린더">
            {{ report.incident_date }}
          </td>
          <td class="col-plate">{{ report.vehicle_number }}</td>
          <td class="col-location">{{ report.location }}</td>
          <td>
            <a href="{{ url_for('static', filename=report.media_path) }}"
               download class="btn-download">
              동영상 다운로드
            </a>
          </td>
          <td>
            <span class="star-icon{% if report.is_starred %} active{% endif %}"
                  data-id="{{ report.report_id }}">
              ★
            </span>
          </td>
          <td><div class="more-menu">⋯
              <ul class="more-dropdown">
            <li>
              <a href="#" class="edit-btn">
              <!-- ① 편집 아이콘 -->
              <img
                src="{{ url_for('static', filename='img/Edit.png') }}"
                alt="Edit"
                class="dropdown-icon"
              >
              Edit
              </a>
            </li>
            <li>
              <a href="#" class="delete-btn">
                <!-- ② 삭제 아이콘 -->
                <img
                  src="{{ url_for('static', filename='img/Delete.png') }}"
                  alt="Delete"
                  class="dropdown-icon"
                >
                Delete
              </a>
            </li>
          </ul>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 1) 메인 디스플레이 영역 -->
  <div class="detail-row">
    {# 왼쪽: 자동 선택된 video_path #}
    <div class="preview-box">
      <video id="main-video" controls muted autoplay loop style="width:100%;">
        {% if video_path %}
        <source src="{{ url_for('static', filename=video_path) }}"
                type="video/mp4">
        {% else %}
        <p>동영상을 찾을 수 없습니다.</p>
        {% endif %}
      </video>
    </div>

    {# 오른쪽: 클릭한 썸네일 이미지 #}
    <div class="preview-box">
      <img id="main-img" alt="선택된 이미지" style="width:100%; display:none;">
    </div>
  </div>

  {# 썸네일 영역: imgshots 우선, 없으면 uploads 전체 #}
  <div class="thumb-row">
    {% if files %}
      {% for path in files %}
        {% set ext = path.rsplit('.',1)[1].lower() %}
        <div class="thumb" data-path="{{ path }}" data-ext="{{ ext }}">
          {% if ext in ['mp4','webm','ogg'] %}
            <video class="thumb-video"
                   src="{{ url_for('static', filename=path) }}"
                   preload="auto" muted style="display:none"></video>
            <canvas class="thumb-canvas"></canvas>
          {% else %}
            <img class="thumb-img"
                 src="{{ url_for('static', filename=path) }}"
                 alt="썸네일">
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="no-files">업로드된 파일이 없습니다.</p>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const baseStatic = "{{ url_for('static', filename='') }}";
      const mainImg   = document.getElementById('main-img');

      // 1) 비디오 썸네일 → 캔버스에 첫 프레임
      document.querySelectorAll('.thumb').forEach(thumb => {
        if (thumb.dataset.ext.match(/mp4|webm|ogg/)) {
          const vid = thumb.querySelector('video.thumb-video');
          const canvas = thumb.querySelector('canvas.thumb-canvas');
          vid.addEventListener('loadeddata', () => {
            canvas.width  = vid.videoWidth;
            canvas.height = vid.videoHeight;
            canvas.getContext('2d').drawImage(vid, 0, 0);
          }, { once: true });
          vid.load();
        }
      });

      // 2) 클릭 시 오른쪽에만 이미지 표시
      document.querySelectorAll('.thumb').forEach(thumb => {
        thumb.addEventListener('click', () => {
          const path = thumb.dataset.path;
          const ext  = thumb.dataset.ext;
          const url  = baseStatic + path;

          if (ext.match(/mp4|webm|ogg/)) {
            const canvas = thumb.querySelector('canvas.thumb-canvas');
            mainImg.src = canvas.toDataURL();
          } else {
            mainImg.src = url;
          }
          mainImg.style.display = 'block';
        });
      });
      document.querySelectorAll('.edit-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    e.preventDefault();
    const tr = btn.closest('tr');
    if (tr.classList.contains('editing')) return;
    tr.classList.add('editing');
    // 원본 보관 (순서: violation_type, incident_date, vehicle_number, location)
    tr._orig = [
      tr.querySelector('td.col-violation').innerText.trim(),
      tr.querySelector('td.col-date').innerText.trim(),
      tr.querySelector('td.col-plate').innerText.trim(),
      tr.querySelector('td.col-location').innerText.trim(),
    ];
    // input으로 교체
    tr.querySelector('td.col-violation').innerHTML = `<input value="${tr._orig[0]}" />`;
    tr.querySelector('td.col-date').innerHTML      = `<input value="${tr._orig[1]}" />`;
    tr.querySelector('td.col-plate').innerHTML     = `<input value="${tr._orig[2]}" />`;
    tr.querySelector('td.col-location').innerHTML  = `<input value="${tr._orig[3]}" />`;

    // 메뉴 바꾸기
    const menu = tr.querySelector('.more-dropdown');
    menu.innerHTML = `
      <li><a href="#" class="save-btn">Save</a></li>
      <li><a href="#" class="cancel-btn">Cancel</a></li>
    `;

    // Save
    menu.querySelector('.save-btn').addEventListener('click', async ev=>{
      ev.preventDefault();
      const payload = {
        row_id: tr.dataset.reportId,
        violation_type:  tr.querySelector('td.col-violation input').value,
        incident_date:   tr.querySelector('td.col-date input').value,
        vehicle_number:  tr.querySelector('td.col-plate input').value,
        location:        tr.querySelector('td.col-location input').value
      };
      try {
        let res = await fetch("{{ url_for('analytics.update_report') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        let j = await res.json();
        if(!res.ok || j.status!=='ok') throw '';
        // 반영
        tr.querySelector('td.col-violation').innerText = payload.violation_type;
        tr.querySelector('td.col-date').innerText      = payload.incident_date;
        tr.querySelector('td.col-plate').innerText     = payload.vehicle_number;
        tr.querySelector('td.col-location').innerText  = payload.location;
        exitEdit(tr);
      } catch {
        alert('저장 실패');
        exitEdit(tr, true);
      }
    });
    // Cancel
    menu.querySelector('.cancel-btn').addEventListener('click', ev=>{
      ev.preventDefault();
      exitEdit(tr, true);
    });
  });
});

function exitEdit(tr, rollback){
  if(rollback){
    tr.querySelector('td.col-violation').innerText = tr._orig[0];
    tr.querySelector('td.col-date').innerText      = tr._orig[1];
    tr.querySelector('td.col-plate').innerText     = tr._orig[2];
    tr.querySelector('td.col-location').innerText  = tr._orig[3];
  }
  delete tr._orig;
  tr.classList.remove('editing');
  tr.querySelector('.more-dropdown').innerHTML = `
    <li><a href="#" class="edit-btn">Edit</a></li>
    <li><a href="#" class="delete-btn">Delete</a></li>
  `;
}

  // 7) 개별 삭제
  document.querySelectorAll('.delete-btn').forEach(btn=>{
    btn.addEventListener('click', e => {
      e.preventDefault();
      const tr = btn.closest('tr'),
            id = tr.dataset.reportId;
      if(!confirm('삭제하시겠습니까?')) return;
      fetch("{{ url_for('analytics.delete_report') }}", {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ row_id: id })
      })
      .then(r=>r.json())
      .then(res=>{
        if(res.status==='ok') tr.remove();
        else alert('삭제 실패');
      })
      .catch(()=>alert('오류'));
    });
  });
  document.querySelectorAll('.star-icon').forEach(icon => {
    icon.addEventListener('click', async () => {
      icon.classList.toggle('active');
      const fav = icon.classList.contains('active'),
            id  = icon.dataset.id;
      try {
        let res = await fetch("{{ url_for('analytics.toggle_favorite') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, fav })
        });
        if(!res.ok) throw '';
      } catch(err) {
        icon.classList.toggle('active');
        alert('즐겨찾기 저장 실패');
      }
    });
  });

    });
  </script>
{% endblock %}