{% extends "layout.html" %}
{% block title %}Analytics{% endblock %}

{% block head %}
  {{ super() }}
  {# List í˜ì´ì§€ CSS ë¶ˆëŸ¬ì˜¤ê¸° #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
  <h2>Analytics</h2>
  <div class="selector-row">
    <table>
      <thead>
        <tr>
          <th class="sortable">ì‹ ê³  ë²ˆí˜¸</th>
          <th class="sortable">êµí†µë²•ê·œ ìœ„ë°˜ ì‚¬í•­</th>
          <th class="sortable">ì˜ìƒ ë‚ ì§œ</th>
          <th>ë²ˆí˜¸íŒ</th>
          <th>ì‹ ê³  ì¥ì†Œ</th>
          <th>ë™ì˜ìƒ ë‹¤ìš´ë¡œë“œ</th>
          <th>ì¦ê²¨ì°¾ê¸°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ report.report_id }}</td>
          <td>
            <img src="{{ url_for('static', filename='img/Alert.png') }}"
          class="icon-sm" alt="">
            {{ report.violation_type or 'â€“' }}
          </td>
          <td>
            <img src="{{ url_for('static', filename='img/Calendar.png') }}"
                 class="icon-sm" alt="ìº˜ë¦°ë”">
            {{ report.incident_date }}
          </td>
          <td>{{ report.vehicle_number }}</td>
          <td>{{ report.location }}</td>
          <td>
            <a href="{{ url_for('static', filename=report.media_path) }}"
               download class="btn-download">
              ë™ì˜ìƒ ë‹¤ìš´ë¡œë“œ
            </a>
          </td>
          <td>
            <span class="star-icon{% if report.is_starred %} active{% endif %}">
              â˜…
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 1) ë©”ì¸ ë””ìŠ¤í”Œë ˆì´ ì˜ì—­ -->
  <div class="detail-row">
    <!-- ì™¼ìª½ì—ëŠ” video -->
    <div class="preview-box">
      <video id="main-video" controls style="display:none; width: 100%; height: auto;"></video>
    </div>
    <!-- ì˜¤ë¥¸ìª½ì—ëŠ” snapshot image -->
    <div class="preview-box">
      <img id="main-img" style="display:none; width: 100%; height: auto;"/>
    </div>
  </div>
  <!-- 2) ì¸ë„¤ì¼ ì˜ì—­ -->
  <div class="thumb-row">
    {% for path in files %}
      <div class="thumb" data-filename="{{ filename }}">
        {% set ext = path.lower().rsplit('.',1)[1] %}
        {% if ext in ['mp4','webm','ogg'] %}
          <video class="thumb-video" 
                 src="{{ url_for('static', filename=path) }}" 
                 preload="auto" muted style="display:none">
          </video>
          <canvas class="thumb-canvas"></canvas>
        {% else %}
          <img class="thumb-img"
               src="{{ url_for('static', filename='uploads/' ~ filename) }}"
               alt="{{ filename }}">
        {% endif %}
      </div>
    {% endfor %}
    {% if not files %}
      <p class="no-files">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- 3) ìŠ¤í¬ë¦½íŠ¸: ì¸ë„¤ì¼ ìƒì„± + í´ë¦­ í•¸ë“¤ëŸ¬ -->
  <script>
    /*const baseUrl = "{{ url_for('static', filename='uploads/') }}";*/
    // 3-1) ì¸ë„¤ì¼ ìƒì„±
    document.querySelectorAll('.thumb').forEach(thumb=>{
      const fn = thumb.dataset.filename;
      const ext = fn.split('.').pop().toLowerCase();

      if (['mp4','webm','ogg'].includes(ext)) {
        const video = thumb.querySelector('video.thumb-video');
        const canvas = thumb.querySelector('canvas.thumb-canvas');
        const ctx = canvas.getContext('2d');

        video.addEventListener('loadeddata', ()=> {
          canvas.width  = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0, canvas.width, canvas.height);
          video.remove();        // ë¹„ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì œê±°
        });
        video.load();
      }
    });

    // 3-2) í´ë¦­ í•¸ë“¤ëŸ¬: ë©”ì¸ ì˜ì—­ì— ë„ìš°ê¸°
    const mainVideo = document.getElementById('main-video');
    const mainImg   = document.getElementById('main-img');

    document.querySelectorAll('.thumb').forEach(thumb=>{
      thumb.addEventListener('click', ()=>{
        const fn  = thumb.dataset.filename;
        const ext = fn.split('.').pop().toLowerCase();
        const full = baseUrl + fn;

        if (['mp4','webm','ogg'].includes(ext)) {
          // â–¶ï¸ ë©”ì¸ ë¹„ë””ì˜¤ ë³´ì—¬ì£¼ê¸°
          mainVideo.src = full;
          mainVideo.style.display = 'block';
          // â–¶ï¸ ë©”ì¸ ìŠ¤ëƒ…ìƒ·ë„ ìƒì„±
          mainImg.style.display = 'block';
          // ì„ì‹œ ë¹„ë””ì˜¤ë¡œ ì²« í”„ë ˆì„ ìº¡ì²˜
          const tmp = document.createElement('video');
          tmp.src   = full;
          tmp.muted = true;
          tmp.addEventListener('loadeddata', ()=>{
            const canvas = document.createElement('canvas');
            canvas.width  = tmp.videoWidth;
            canvas.height = tmp.videoHeight;
            canvas.getContext('2d').drawImage(tmp,0,0);
            mainImg.src = canvas.toDataURL();  
          });
          tmp.load();
        } else {
          // ğŸ–¼ï¸ ê·¸ëƒ¥ ì´ë¯¸ì§€ íŒŒì¼ì¼ ë•Œ
          mainVideo.style.display = 'none';
          mainImg.src = full;
          mainImg.style.display = 'block';
        }
      });
    });
    document.querySelectorAll('.star-icon').forEach(icon => {
    icon.addEventListener('click', async () => {
      icon.classList.toggle('active');
      const fav = icon.classList.contains('active'),
            id  = icon.dataset.id;
      try {
        let res = await fetch("{{ url_for('list.toggle_favorite') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, fav })
        });
        if(!res.ok) throw '';
      } catch(err) {
        icon.classList.toggle('active');
        alert('ì¦ê²¨ì°¾ê¸° ì €ì¥ ì‹¤íŒ¨');
      }
    });
  });
  </script>
{% endblock %}