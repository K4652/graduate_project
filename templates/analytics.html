{% extends "layout.html" %}
{% block title %}Analytics{% endblock %}

{% block head %}
  {{ super() }}
  {# List 페이지 CSS 불러오기 #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
{% endblock %}

{% block content %}
  <h2>Analytics</h2>
  <div class="selector-row">
    <table>
      <thead>
        <tr>
          <th class="sortable">신고 번호</th>
          <th class="sortable">교통법규 위반 사항</th>
          <th class="sortable">영상 날짜</th>
          <th>번호판</th>
          <th>신고 장소</th>
          <th>동영상 다운로드</th>
          <th>즐겨찾기</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ report.report_id }}</td>
          <td>
            <img src="{{ url_for('static', filename='img/Alert.png') }}"
          class="icon-sm" alt="">
            {{ report.violation_type or '–' }}
          </td>
          <td>
            <img src="{{ url_for('static', filename='img/Calendar.png') }}"
                 class="icon-sm" alt="캘린더">
            {{ report.incident_date }}
          </td>
          <td>{{ report.vehicle_number }}</td>
          <td>{{ report.location }}</td>
          <td>
            <a href="{{ url_for('static', filename=report.media_path) }}"
               download class="btn-download">
              동영상 다운로드
            </a>
          </td>
          <td>
            <span class="star-icon{% if report.is_starred %} active{% endif %}">
              ★
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 1) 메인 디스플레이 영역 -->
  <div class="detail-row">
    {# 왼쪽: 자동 선택된 video_path #}
    <div class="preview-box">
      <video id="main-video" controls muted autoplay loop style="width:100%;">
        {% if video_path %}
        <source src="{{ url_for('static', filename=video_path) }}"
                type="video/mp4">
        {% else %}
        <p>동영상을 찾을 수 없습니다.</p>
        {% endif %}
      </video>
    </div>

    {# 오른쪽: 클릭한 썸네일 이미지 #}
    <div class="preview-box">
      <img id="main-img" alt="선택된 이미지" style="width:100%; display:none;">
    </div>
  </div>

  {# 썸네일 영역: imgshots 우선, 없으면 uploads 전체 #}
  <div class="thumb-row">
    {% if files %}
      {% for path in files %}
        {% set ext = path.rsplit('.',1)[1].lower() %}
        <div class="thumb" data-path="{{ path }}" data-ext="{{ ext }}">
          {% if ext in ['mp4','webm','ogg'] %}
            <video class="thumb-video"
                   src="{{ url_for('static', filename=path) }}"
                   preload="auto" muted style="display:none"></video>
            <canvas class="thumb-canvas"></canvas>
          {% else %}
            <img class="thumb-img"
                 src="{{ url_for('static', filename=path) }}"
                 alt="썸네일">
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="no-files">업로드된 파일이 없습니다.</p>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const baseStatic = "{{ url_for('static', filename='') }}";
      const mainImg   = document.getElementById('main-img');

      // 1) 비디오 썸네일 → 캔버스에 첫 프레임
      document.querySelectorAll('.thumb').forEach(thumb => {
        if (thumb.dataset.ext.match(/mp4|webm|ogg/)) {
          const vid = thumb.querySelector('video.thumb-video');
          const canvas = thumb.querySelector('canvas.thumb-canvas');
          vid.addEventListener('loadeddata', () => {
            canvas.width  = vid.videoWidth;
            canvas.height = vid.videoHeight;
            canvas.getContext('2d').drawImage(vid, 0, 0);
          }, { once: true });
          vid.load();
        }
      });

      // 2) 클릭 시 오른쪽에만 이미지 표시
      document.querySelectorAll('.thumb').forEach(thumb => {
        thumb.addEventListener('click', () => {
          const path = thumb.dataset.path;
          const ext  = thumb.dataset.ext;
          const url  = baseStatic + path;

          if (ext.match(/mp4|webm|ogg/)) {
            const canvas = thumb.querySelector('canvas.thumb-canvas');
            mainImg.src = canvas.toDataURL();
          } else {
            mainImg.src = url;
          }
          mainImg.style.display = 'block';
        });
      });
    });
  </script>
{% endblock %}