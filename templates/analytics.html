{% extends "layout.html" %}
{% block title %}Analytics{% endblock %}

{% block head %}
  {{ super() }}
  {# List 페이지 CSS 불러오기 #}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}
  <h2>Analytics</h2>
  <div class="selector-row">
    <table>
      <thead>
        <tr>
          <th class="sortable">신고 번호</th>
          <th class="sortable">교통법규 위반 사항</th>
          <th class="sortable">영상 날짜</th>
          <th>번호판</th>
          <th>신고 장소</th>
          <th>동영상 다운로드</th>
          <th>즐겨찾기</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ report.report_id }}</td>
          <td>
            <img src="{{ url_for('static', filename='img/Alert.png') }}"
          class="icon-sm" alt="">
            {{ report.violation_type or '–' }}
          </td>
          <td>
            <img src="{{ url_for('static', filename='img/Calendar.png') }}"
                 class="icon-sm" alt="캘린더">
            {{ report.incident_date }}
          </td>
          <td>{{ report.vehicle_number }}</td>
          <td>{{ report.location }}</td>
          <td>
            <a href="{{ url_for('static', filename=report.media_path) }}"
               download class="btn-download">
              동영상 다운로드
            </a>
          </td>
          <td>
            <span class="star-icon{% if report.is_starred %} active{% endif %}">
              ★
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 1) 메인 디스플레이 영역 -->
  <div class="detail-row">
    <!-- 왼쪽에는 video -->
    <div class="preview-box">
      <video id="main-video" controls style="display:none; width: 100%; height: auto;"></video>
    </div>
    <!-- 오른쪽에는 snapshot image -->
    <div class="preview-box">
      <img id="main-img" style="display:none; width: 100%; height: auto;"/>
    </div>
  </div>
  <!-- 2) 썸네일 영역 -->
  <div class="thumb-row">
    {% for path in files %}
      <div class="thumb" data-filename="{{ filename }}">
        {% set ext = path.lower().rsplit('.',1)[1] %}
        {% if ext in ['mp4','webm','ogg'] %}
          <video class="thumb-video" 
                 src="{{ url_for('static', filename=path) }}" 
                 preload="auto" muted style="display:none">
          </video>
          <canvas class="thumb-canvas"></canvas>
        {% else %}
          <img class="thumb-img"
               src="{{ url_for('static', filename='uploads/' ~ filename) }}"
               alt="{{ filename }}">
        {% endif %}
      </div>
    {% endfor %}
    {% if not files %}
      <p class="no-files">업로드된 파일이 없습니다.</p>
    {% endif %}
  </div>

  <!-- 3) 스크립트: 썸네일 생성 + 클릭 핸들러 -->
  <script>
    /*const baseUrl = "{{ url_for('static', filename='uploads/') }}";*/
    // 3-1) 썸네일 생성
    document.querySelectorAll('.thumb').forEach(thumb=>{
      const fn = thumb.dataset.filename;
      const ext = fn.split('.').pop().toLowerCase();

      if (['mp4','webm','ogg'].includes(ext)) {
        const video = thumb.querySelector('video.thumb-video');
        const canvas = thumb.querySelector('canvas.thumb-canvas');
        const ctx = canvas.getContext('2d');

        video.addEventListener('loadeddata', ()=> {
          canvas.width  = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video,0,0, canvas.width, canvas.height);
          video.remove();        // 비디오 엘리먼트 제거
        });
        video.load();
      }
    });

    // 3-2) 클릭 핸들러: 메인 영역에 띄우기
    const mainVideo = document.getElementById('main-video');
    const mainImg   = document.getElementById('main-img');

    document.querySelectorAll('.thumb').forEach(thumb=>{
      thumb.addEventListener('click', ()=>{
        const fn  = thumb.dataset.filename;
        const ext = fn.split('.').pop().toLowerCase();
        const full = baseUrl + fn;

        if (['mp4','webm','ogg'].includes(ext)) {
          // ▶️ 메인 비디오 보여주기
          mainVideo.src = full;
          mainVideo.style.display = 'block';
          // ▶️ 메인 스냅샷도 생성
          mainImg.style.display = 'block';
          // 임시 비디오로 첫 프레임 캡처
          const tmp = document.createElement('video');
          tmp.src   = full;
          tmp.muted = true;
          tmp.addEventListener('loadeddata', ()=>{
            const canvas = document.createElement('canvas');
            canvas.width  = tmp.videoWidth;
            canvas.height = tmp.videoHeight;
            canvas.getContext('2d').drawImage(tmp,0,0);
            mainImg.src = canvas.toDataURL();  
          });
          tmp.load();
        } else {
          // 🖼️ 그냥 이미지 파일일 때
          mainVideo.style.display = 'none';
          mainImg.src = full;
          mainImg.style.display = 'block';
        }
      });
    });
    document.querySelectorAll('.star-icon').forEach(icon => {
    icon.addEventListener('click', async () => {
      icon.classList.toggle('active');
      const fav = icon.classList.contains('active'),
            id  = icon.dataset.id;
      try {
        let res = await fetch("{{ url_for('list.toggle_favorite') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, fav })
        });
        if(!res.ok) throw '';
      } catch(err) {
        icon.classList.toggle('active');
        alert('즐겨찾기 저장 실패');
      }
    });
  });
  </script>
{% endblock %}