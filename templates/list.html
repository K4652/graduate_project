{% extends "layout.html" %}

{% block title %}List{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">

  
{% endblock %}

{% block content %}
<h2>영상 리스트</h2>
<div class="selector-row">
  <table>
    <thead>
      <tr>
        <th class="select-all-header">
      <input type="checkbox" id="select-all">
    </th>
    <th class="sortable" data-type="number">
      신고 번호 <span class="arrow">▼</span>
    </th>
    <th class="sortable" data-type="string">
      교통법규 위반 사항 <span class="arrow">▼</span>
    </th>
    <th class="sortable" data-type="date">
      영상 날짜 <span class="arrow">▼</span>
    </th>
    <th>번호판</th>
    <th>신고 장소</th>

    <!-- (A) 다운로드 선택 항목 버튼 -->
    <th>
      <button id="download-selected" class="btn-download">
        선택 동영상 다운로드
      </button>
    </th>
    <th>
      영상분석
    </th>
    <th>분석 완료</th>
    <th class="sortable" data-type="true">
      즐겨찾기 <span class="arrow">▼</span>
    </th>
        <th> <div class="more-menu">⋯ <ul class="more-dropdown">
          <li>
        <a href="#" id="delete-selected" class="delete-selected">
              <img
                src="{{ url_for('static', filename='img/Delete.png') }}"
                class="dropdown-icon"
                alt="Delete Selected"
              >
              Delete
            </a>
      </li>
        </ul></div></th><!-- 더보기 -->
      </tr>
    </thead>
    <tbody>
      {% for r in reports %}
      <tr data-report-id="{{ r.report_id }}">
        <td><input type="checkbox" class="row-checkbox"></td>
        <td>{{ r.report_id }}</td>
        <td><img src="{{ url_for('static', filename='img/Alert.png') }}"
          class="icon-sm" alt="">{{ r.violation_type or '-' }}
        </td>
        <td><img src="{{ url_for('static', filename='img/Calendar.png') }}"
          class="icon-sm" alt="">
          {{ r.incident_date }}</td>
        <td>{{ r.vehicle_number or '-' }}</td>
        <td>{{ r.location }}</td>
        <td><a href="{{ url_for('static', filename=r.media_path) }}"
           download class="btn-download">동영상 다운로드</a></td>
        <td>
          <a href="{{ url_for('analytics.view', report_id=r.report_id) }}"
             class="btn-link">
             영상 분석 연결
           </a>
        </td>
        <td>
          <button class="btn-complete" data-report-id="{{ r.report_id }}">
            분석 완료
          </button>

          <script>
          document.querySelectorAll('.btn-complete').forEach(btn => {
            btn.addEventListener('click', () => {
              const reportId = btn.dataset.reportId;
              fetch(`/list/complete/${reportId}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => alert(data.message))
                .catch(err => alert("오류 발생: " + err));
            });
          });
          </script>

        </td>
        <td>
    <span
      class="star-icon{% if r.is_starred %} active{% endif %}"
      data-id="{{ r.report_id }}"
    >★</span>
  </td>
        <td><div class="more-menu">⋯
              <ul class="more-dropdown">
      <li>
        <a href="#" class="edit-btn">
          <!-- ① 편집 아이콘 -->
          <img
            src="{{ url_for('static', filename='img/Edit.png') }}"
            alt="Edit"
            class="dropdown-icon"
          >
          Edit
        </a>
      </li>
      <li>
        <a href="#" class="delete-btn">
          <!-- ② 삭제 아이콘 -->
          <img
            src="{{ url_for('static', filename='img/Delete.png') }}"
            alt="Delete"
            class="dropdown-icon"
          >
          Delete
        </a>
      </li>
    </ul>
            </div>
          </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // 요소 가져오기
  const selectAllCb = document.getElementById('select-all');
  const rowCbs      = document.querySelectorAll('.row-checkbox');
  const dlBtn       = document.getElementById('download-selected');
  const delBtn      = document.getElementById('delete-selected');

  // 1) 전체 선택 토글
  selectAllCb.addEventListener('change', () => {
    rowCbs.forEach(cb => cb.checked = selectAllCb.checked);
  });

  // 2) 선택 다운로드
  dlBtn.addEventListener('click', e => {
    e.preventDefault();
    const checked = Array.from(rowCbs).filter(cb=>cb.checked);
    if (!checked.length) return alert('먼저 행을 선택하세요.');
    checked.forEach(cb => {
      const link = cb.closest('tr').querySelector('a.btn-download');
      const tmp = document.createElement('a');
      tmp.href = link.href; tmp.download = '';
      document.body.appendChild(tmp);
      tmp.click();
      document.body.removeChild(tmp);
    });
  });

  // 3) 선택 삭제
  delBtn.addEventListener('click', e => {
    e.preventDefault();
    const checked = Array.from(rowCbs).filter(cb=>cb.checked);
    if (!checked.length) return alert('먼저 행을 선택하세요.');
    if (!confirm(`${checked.length}개 행을 정말 삭제하시겠습니까?`)) return;
    const ids = checked.map(cb => cb.closest('tr').dataset.reportId);
    fetch('{{ url_for("list.delete_selected") }}', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ ids })
    })
    .then(r=>r.json())
    .then(res => {
      if (res.success) {
        checked.forEach(cb => cb.closest('tr').remove());
      } else {
        alert('삭제 실패: '+res.message);
      }
    })
    .catch(()=>alert('네트워크 오류'));
  });

  // 4) 컬럼별 정렬
  const getCellValue = (tr, idx) => tr.children[idx].innerText.trim();
  const comparer = (idx, asc, type) => (a,b) => {
    let v1 = getCellValue(a, idx), v2 = getCellValue(b, idx), mult=asc?1:-1;
    if (type==='number')   return (parseInt(v1.replace(/\D/g,''),10)||0 - parseInt(v2.replace(/\D/g,''),10)||0)*mult;
    if (type==='date')     return (new Date(v1)-new Date(v2))*mult;
    if (type==='true') {
      const aStar = a.querySelector('.star-icon.active')!=null;
      const bStar = b.querySelector('.star-icon.active')!=null;
      return ((aStar===bStar)?0:(aStar?1:-1))*mult;
    }
    return v1.localeCompare(v2,undefined,{numeric:true})*mult;
  };
  document.querySelectorAll('th.sortable').forEach(th => {
    let asc = true;
    th.addEventListener('click', () => {
      const table = th.closest('table'), tbody = table.querySelector('tbody'),
            idx = th.cellIndex, type = th.dataset.type||'string';
      // arrow
      table.querySelectorAll('.arrow').forEach(a=>a.textContent='');
      th.querySelector('.arrow').textContent = asc?'▲':'▼';
      asc = !asc;
      Array.from(tbody.querySelectorAll('tr'))
           .sort(comparer(idx, asc, type))
           .forEach(tr=>tbody.appendChild(tr));
    });
  });

  // 5) 즐겨찾기 토글
  document.querySelectorAll('.star-icon').forEach(icon => {
    icon.addEventListener('click', async () => {
      icon.classList.toggle('active');
      const fav = icon.classList.contains('active'),
            id  = icon.dataset.id;
      try {
        let res = await fetch("{{ url_for('list.toggle_favorite') }}", {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ id, fav })
        });
        if(!res.ok) throw '';
      } catch(err) {
        icon.classList.toggle('active');
        alert('즐겨찾기 저장 실패');
      }
    });
  });

  // 6) 개별 더보기(Edit/Delete)
  document.querySelectorAll('.edit-btn').forEach(btn=>{
    btn.addEventListener('click', e => {
      e.preventDefault();
      const tr = btn.closest('tr');
      if (tr.classList.contains('editing')) return;
      tr.classList.add('editing');
      // 원본 보관
      tr._orig = [2,3,4,5].map(i=>tr.children[i].innerText.trim());
      // input 교체
      [2,3,4,5].forEach((i, idx)=>{
        const cell = tr.children[i], val = cell.innerText.trim();
        cell.innerHTML = `<input value="${val}" />`;
      });
      // 메뉴 바꾸기
      const menu = tr.querySelector('.more-dropdown');
      menu.innerHTML = `
        <li><a href="#" class="save-btn">Save</a></li>
        <li><a href="#" class="cancel-btn">Cancel</a></li>
      `;
      // Save
      menu.querySelector('.save-btn').addEventListener('click', async ev=>{
        ev.preventDefault();
        const payload = { row_id: tr.dataset.reportId };
        [2,3,4,5].forEach(i=>{
          payload[i] = tr.children[i].querySelector('input').value;
        });
        try {
          let res = await fetch("{{ url_for('list.update_report') }}", {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          });
          if(!res.ok) throw '';
          // 반영
          [2,3,4,5].forEach(i=>{
            tr.children[i].innerText = payload[i];
          });
          exitEdit(tr);
        } catch {
          alert('저장 실패');
          exitEdit(tr, true);
        }
      });
      // Cancel
      menu.querySelector('.cancel-btn').addEventListener('click', ev=>{
        ev.preventDefault();
        exitEdit(tr, true);
      });
    });
  });
  function exitEdit(tr, rollback){
    if(rollback){
      [2,3,4,5].forEach((i,idx)=>{
        tr.children[i].innerText = tr._orig[idx];
      });
    }
    delete tr._orig;
    tr.classList.remove('editing');
    // 메뉴 복원
    tr.querySelector('.more-dropdown').innerHTML = `
      <li><a href="#" class="edit-btn">Edit</a></li>
      <li><a href="#" class="delete-btn">Delete</a></li>
    `;
  }

  // 7) 개별 삭제
  document.querySelectorAll('.delete-btn').forEach(btn=>{
    btn.addEventListener('click', e => {
      e.preventDefault();
      const tr = btn.closest('tr'),
            id = tr.dataset.reportId;
      if(!confirm('삭제하시겠습니까?')) return;
      fetch("{{ url_for('list.delete_report') }}", {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ row_id: id })
      })
      .then(r=>r.json())
      .then(res=>{
        if(res.status==='ok') tr.remove();
        else alert('삭제 실패');
      })
      .catch(()=>alert('오류'));
    });
  });

});
</script>
{% endblock %}
